from PyQt5 import QtCore, QtGui, QtWidgets
from Application import Application
from pyCategoryPop import Ui_createDialog
from pyEditCategoryPop import Ui_editDialog

class DragDropTableWidget(QtWidgets.QTableWidget):
  '''
  This class utilizes the concept of inheritance. It is
  the child class of QTableWidget, which means that it 
  has all of the functionality of QTableWidget, but has
  the ability to implement its own extra methods that
  QTableWidget does not have, and re-implement QTableWidget
  methods in its own specialized way. In our case,
  we are re-implementing the dropEvent() method so that
  it carries out our own specified functionality when called -
  I believe it does nothing by default.
  '''
  def __init__(self, app, mainWindow, parent = None):
    self.app = app
    self.mainWindow = mainWindow
    super(DragDropTableWidget, self).__init__(parent)

  def dropEvent(self, event):
    event.accept()
    row = self.mainWindow.tableWidget.currentRow()
    referenceNumber = int(self.mainWindow.tableWidget.item(row, 0).text())
    location = self.mainWindow.tableWidget.item(row, 1).text()
    amount = self.mainWindow.tableWidget.item(row, 2).text()
    self.mainWindow.tableWidget.removeRow(row)
    c = self.app.getCategoryNamesList()[self.mainWindow.categoryWidget.currentIndex() + 1]
    self.app.registerCompletedTransaction(c, referenceNumber)
    self.app.saveData()
    # print the keywords of the updated category for debugging purposes
    print(c, self.app.getKeywordsByCategory(c))
    self.mainWindow.moveRowToDropDestination(referenceNumber, location, amount, c)


##############################################################################################
                    # end of auto-generated code
##############################################################################################
        
        # placed here to instantiate the backend in the GUI at the start, 
        # it makes it easier for the backed to be passed into the popup windows
        # where several functions are called
        self.app = Application()
        self.app.initialize()
        self.filename = "../CreditCard3"
        self.app.sortCompletedTransactions(self.filename)
        self.createCategoryWidget()
        self.printUnhandledTransactions()
    

        self.openCatPopUp.clicked.connect(self.openNewCatPop)
        self.editCategory.clicked.connect(self.openEditCatPop)
        self.deleteCategory.clicked.connect(self.deleteSelectedCategory)


    def openNewCatPop(self):
        '''
        when newCategory button is pushed on categorize tab, this will
        prompt a popup that allows user to enter a new category, monthly allotment
        and a list of potential keywords
        '''
        self.Dialog = QtWidgets.QDialog()
        self.ui = Ui_createDialog()
        self.ui.setupUi(self.Dialog, self.app)
        self.ui.saveCategoryInfo.clicked.connect(self.updateCategoryWidget)
        self.Dialog.show()

    def openEditCatPop(self):
        '''
        Opens same window as openNewCatPop but autofills the 
        information and allows it to be edited
        '''

        self.tab = self.categoryWidget.currentIndex()        
        self.index = self.app.getCategoryNamesList()[self.tab+1]
        self.Dialog = QtWidgets.QDialog()
        self.editUi = Ui_editDialog()
        self.editUi.setupUi(self.Dialog, self.app)
        self.Dialog.show()

        self.editUi.newCategoryName.setText(self.index)
        self.editUi.newCategoryAllotment.setText(str(self.app.getAmountAllottedByCategory(self.index)))

        # First, check if there are any keywords to be added.
        # Add items only if an iterable list of keywords is returned.
        keywords = self.app.getKeywordsByCategory(self.index)
        if keywords != None:
            self.editUi.newCategoryKeywords.addItems(keywords)


    def updateCategoryWidget(self):
        # bugger
        self.app.saveData()
        self.createCategoryWidget()

    def createCategoryWidget(self):
        self.categoryWidget.clear()
        for category in self.app.getCategoryNamesList():
            if category != "Unhandled":
                tab = DragDropTableWidget(self.app, self)
                tab.setAcceptDrops(True)
                self.categoryWidget.addTab(tab, category)
                self.categoryWidget.setCurrentWidget(tab)
                for i in range(3):
                    self.categoryWidget.currentWidget().insertColumn(i)
                    self.item = self.categoryWidget.horizontalHeaderItem(0)
                self.fillCategoryWidget(category)
        '''
        # resizing columns
        self.header = self.tableWidget.horizontalHeader() 
        self.header.setSectionResizeMode(0, QtWidgets.QHeaderView.ResizeToContents)
        self.header.setSectionResizeMode(1, QtWidgets.QHeaderView.Stretch)
        self.header.setSectionResizeMode(2, QtWidgets.QHeaderView.ResizeToContents)
        '''
    def moveRowToDropDestination(self, referenceNumber, location, amount, category):
        rowPos = self.categoryWidget.currentWidget().rowCount()
        self.categoryWidget.currentWidget().insertRow(rowPos)
        self.categoryWidget.currentWidget().setItem(rowPos, 0, QtWidgets.QTableWidgetItem(str(referenceNumber)))
        self.categoryWidget.currentWidget().setItem(rowPos, 1, QtWidgets.QTableWidgetItem(location))
        self.categoryWidget.currentWidget().setItem(rowPos, 2, QtWidgets.QTableWidgetItem(amount))

        
    def fillCategoryWidget(self, category):
        #self.categoryWidget.currentWidget().clear()
        for t in self.app.getCompletedTransactionsByCategory(category).values():
            rowPos = self.categoryWidget.currentWidget().rowCount()
            self.categoryWidget.currentWidget().insertRow(rowPos)
            self.categoryWidget.currentWidget().setItem(rowPos, 0, QtWidgets.QTableWidgetItem(str(t.referenceNumber)))
            self.categoryWidget.currentWidget().setItem(rowPos, 1, QtWidgets.QTableWidgetItem(t.location))
            self.categoryWidget.currentWidget().setItem(rowPos, 2, QtWidgets.QTableWidgetItem(t.amount))


    def printUnhandledTransactions(self):
        for t in self.app.getUnhandledTransactions().values():
            rowPos = self.tableWidget.rowCount()
            self.tableWidget.insertRow(rowPos)
            self.tableWidget.setItem(rowPos, 0, QtWidgets.QTableWidgetItem(str(t.referenceNumber)))
            self.tableWidget.setItem(rowPos, 1, QtWidgets.QTableWidgetItem(t.location))
            self.tableWidget.setItem(rowPos, 2, QtWidgets.QTableWidgetItem(t.amount))
            # resizing the columns
            header = self.tableWidget.horizontalHeader()       
            header.setSectionResizeMode(0, QtWidgets.QHeaderView.ResizeToContents)
            header.setSectionResizeMode(1, QtWidgets.QHeaderView.Stretch)
            header.setSectionResizeMode(2, QtWidgets.QHeaderView.ResizeToContents)
            
    def deleteSelectedCategory(self):
        self.tab = self.categoryWidget.currentIndex() + 1        
        self.index = self.app.getCategoryNamesList()[self.tab]
        self.app.deleteCategory(self.index)
        self.updateCategoryWidget()

    

    def updateCategoryListOfTransactions(self):
        self.tab = self.categoryWidget.currentIndex() + 1
        self.index = self.app.getCategoryNamesList()[self.tab]
        

##############################################################################################
                    # beginning of auto-generated code
######################################################################################################


categoryPopup




from PyQt5 import QtCore, QtGui, QtWidgets
from APIData import CategoryData


##############################################################################################
                    # end of auto-generated code
##############################################################################################

        self.app = App

##############################################################################################
                    # begin auto-generated code
##############################################################################################





##############################################################################################
                    # end of auto-generated code
##############################################################################################
    

        self.keywordList = []
        self.addNewCategoryKeyword.clicked.connect(self.appendKeyword)
        self.saveCategoryInfo.clicked.connect(self.createNewCategory)

    def appendKeyword(self):
        '''
        Simultaneously adds keyword to idKeywords list for respective category
        and displays new words in list widget in pop up window
        '''
        self.newCategoryKeywords.addItem(str(self.newCategoryKeywordField.text()))
        self.keywordList.append(self.newCategoryKeywordField.text())
        self.newCategoryKeywordField.setText("")
        
      
      
    def createNewCategory(self):
        '''
        Creates a category data object and assigns attributes based on 
        the entries in the newCategoryPopup
        '''
        newCategory = CategoryData()
        newCategory.name = str(self.newCategoryName.text())
        newCategory.monthlyAllotment = float(self.newCategoryAllotment.text())
        newCategory.idKeywords = self.keywordList
        self.app.createNewCategory(newCategory)

##############################################################################################
                    # begin auto-generated code
##############################################################################################